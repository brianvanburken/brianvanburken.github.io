<!DOCTYPE html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/atom+xml title="RSS Feed" href=https://brianvanburken.nl/feed.xml><title>Maybe Don&#x27;t Use Maybe? | Brian van Burken</title><meta property=og:title content="Maybe Don&#x27;t Use Maybe?"><meta name=description content="At my work I&#x27;ve come across a code that had more branches than were possible in the logic of the domain."><meta property=og:description content="At my work I&#x27;ve come across a code that had more branches than were possible in the logic of the domain."><meta property=og:type content=article><meta property=og:url content=https:&#x2F;&#x2F;brianvanburken.nl&#x2F;maybe-dont-use-maybe&#x2F;><meta property=og:site_name content="Brian van Burken"><link rel=canonical href=https:&#x2F;&#x2F;brianvanburken.nl&#x2F;maybe-dont-use-maybe&#x2F;><meta property=article:published_time content=2018-08-13T00:00:00+00:00><style>html{color:#fff;background:#0b0e14}@media (prefers-color-scheme:light){html{color:#0b0e14;background:#fff}}body{font-family:"Avenir Next","Open Sans",Helvetica,sans-serif;font-size:1.125rem;max-width:70ch;margin:1.5rem auto;padding:0 1.5rem}article,code,footer,h1,h2,ol,p,pre{margin:1.5rem 0;line-height:1.5rem}h1{font-size:2.5rem;line-height:3rem}ol{padding-left:1.5rem}p{text-align:justify}img{max-width:100%}h2{margin-top:3rem}a,a code{color:#fa3}a:visited{color:#ff9500}a:focus,a:hover{color:#ffbf66}footer{border-top:1px solid #bfbdb6;padding-top:1.5rem}code,pre{font-size:.875rem;word-spacing:normal;word-break:normal;word-wrap:normal;hyphens:none;color:#bfbdb6;background:#0b0e14;border-radius:.375rem}pre{overflow:auto;padding:1.5rem}li code,p code{line-height:1;outline:3px solid #0b0e14;margin:0 2px}.b{color:#ff8f40}.f{color:#59c2ff}.d{color:#bfbdb6}.c{color:#f29668}.e{color:#bfbdb6b3}.h{color:#aad94c}.g{color:#ffb454}</style><p><a href=/ title="Overview of all my writings">Writings</a> | <a href=https://github.com/brianvanburken title="Visit my GitHub profile" target=_blank rel="noopener noreferrer">GitHub</a> | <a href=https://linkedin.com/in/brianvanburken title="Visit my LinkedIn profile" target=_blank rel="noopener noreferrer">LinkedIn</a><article itemscope itemtype=http://schema.org/BlogPosting><h1 itemprop="name headline">Maybe Don&#x27;t Use Maybe?</h1><section itemprop=articleBody><p>Your code could be littered with branches that result in invalid data and should never happen, but are allowed. We found such a case, at my work, where we allowed multiple variants of data, and it broke our code logic. We use <a rel="noopener nofollow noreferrer external" target=_blank href=http://elm-lang.org/ >Elm</a> and fixed it using its type system. Although we describe the solution for Elm in this blog, the cases and fixes also apply to other similar languages like <a rel="noopener nofollow noreferrer external" target=_blank href=https://www.haskell.org/ >Haskell</a> and <a rel="noopener nofollow noreferrer external" target=_blank href=http://www.purescript.org/ >PureScript</a>. In this blog post we find the seemly impossible bug using examples written in Elm and go through a step by step progress to fix it. At the end, you could find similar cases in your application and know a way to fix them. Before we go fix our bug let’s get clear on the domain model.<h2 id=how-did-we-get-here>How did we get here?</h2><p>Our domain contains the model "Question" which can have exactly one "Answer" or is not answered yet. If the question has been answered then we receive the timestamp and content of the answer. This all will be sent by an API using JSON. Note: for this post, I've simplified our domain to this specific case.<p>Our back-end was built separate from the front-end and one of the decisions of the back-end team was to send out both fields on the root level of the JSON document. These fields will always be present and, when there is no answer yet, default to <code>null</code>.<p>Our domain code started out like this:<pre><code><span class=a><span class=b>type alias Question</span><span class=c> =</span></span>
<span class=a><span class=d>    { id: </span><span class=b>String</span></span>
<span class=a><span class=e>    ,</span><span class=f> date</span><span class=b> : Date</span></span>
<span class=a><span class=e>    ,</span><span class=d> content: </span><span class=b>String</span></span>
<span class=a><span class=e>    ,</span><span class=d> answer: </span><span class=b>Answer</span></span>
<span class=a><span class=d>    }</span></span>

<span class=a><span class=b>type Answer</span><span class=c> =</span><span class=d> Answer (</span><span class=b>Maybe String</span><span class=d>) (</span><span class=b>Maybe Date</span><span class=d>)</span></span>
</code></pre><p>Here we store both fields on the question at the same level as we received from the back-end. And our decoder looked like this:<pre><code><span class=a><span class=b>import</span><span class=d> Json</span><span class=b>.</span><span class=d>Decode </span><span class=b>as</span><span class=d> JD</span></span>
<span class=a><span class=b>import</span><span class=d> DateTime  -- Note: DateTime contains our internal decoder for dates</span></span>

<span class=a><span class=g>decoder</span><span class=b> :</span><span class=d> JD</span><span class=b>.Decoder Question</span></span>
<span class=a><span class=g>decoder</span><span class=b> =</span></span>
<span class=a><span class=d>    JD</span><span class=b>.</span><span class=d>map4 Question</span></span>
<span class=a><span class=d>        (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"id"</span><span class=d> JD</span><span class=b>.</span><span class=d>string)</span></span>
<span class=a><span class=d>        (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"date"</span><span class=d> DateTime</span><span class=b>.</span><span class=d>decoder)</span></span>
<span class=a><span class=d>        (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"content"</span><span class=d> JD</span><span class=b>.</span><span class=d>string)</span></span>
<span class=a><span class=d>        (JD</span><span class=b>.</span><span class=d>map2 Answer</span></span>
<span class=a><span class=d>            (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"answer"</span><span class=d> (JD</span><span class=b>.</span><span class=d>maybe JD</span><span class=b>.</span><span class=d>string))</span></span>
<span class=a><span class=d>            (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"answeredOn"</span><span class=d> (JD</span><span class=b>.</span><span class=d>maybe DateTime</span><span class=b>.</span><span class=d>decoder))</span></span>
<span class=a><span class=d>		)</span></span>
</code></pre><h2 id=maybe-we-have-a-bug>Maybe we have a bug?</h2><p>If we look closer at our <code>Answer</code> type we see that it takes two <code>Maybe</code>'s. If we think about it in terms of <a rel="noopener nofollow noreferrer external" target=_blank href=https://codewords.recurse.com/issues/three/algebra-and-calculus-of-algebraic-data-types>algebraic data types</a> we can reason that this solution has four possible cases for our answer:<ol><li><code>Answer (Just _) (Just _)</code><li><code>Answer (Just _) Nothing</code><li><code>Answer Nothing (Just _)</code><li><code>Answer Nothing Nothing</code></ol><p>Are all these cases valid? If we revisit the domain logic then it becomes more clear: if there is an answer we receive both <code>answer</code> and <code>answeredOn</code> filled in, else we receive both fields with a null value. This means we have only two possible cases:<ol><li>we have an answer and both fields are filled in<li>we have no answer and both fields are empty</ol><p>This is not what we represent in our code. There are four possible cases right now! We only want the two cases that are valid and we can’t express that right now. This allowed for a bug to slip in where one of the fields for an answer was set to <code>null</code> and made our application show contradicting information to our users. Luckily for us, we can leverage Elm’s awesome type system to make the other cases impossible! Let’s improve our code.<h2 id=maybe-this-will-fix-it>Maybe this will fix it?</h2><p>We could wrap our <code>Answer</code> type in a <code>Maybe</code> and remove the <code>Maybe</code> for both the values or another approach is to expand our <code>Answer</code> type to a <a rel="noopener nofollow noreferrer external" target=_blank href=https://guide.elm-lang.org/types/custom_types.html>Custom Type</a> (also called Union Type). Before we refactor our code let's think about how our code looks in each approach. Compare both examples below one of each possible fix and look at how we would use it rendering our answer. First look at the approach using <code>Maybe</code>:<pre><code><span class=a><span class=b>import</span><span class=d> Html </span><span class=b>exposing</span><span class=d> (</span><span class=b>Html</span><span class=d>)</span></span>

<span class=a><span class=b>type Answer</span><span class=c> =</span><span class=d> Answer </span><span class=b>String Date</span></span>

<span class=a><span class=b>type alias Question</span><span class=c> =</span></span>
<span class=a><span class=d>    { id: </span><span class=b>String</span></span>
<span class=a><span class=e>    ,</span><span class=f> date</span><span class=b> : Date</span></span>
<span class=a><span class=e>    ,</span><span class=d> content: </span><span class=b>String</span></span>
<span class=a><span class=e>    ,</span><span class=d> answer: </span><span class=b>Maybe Answer</span></span>
<span class=a><span class=d>    }</span></span>

<span class=a><span class=g>viewAnswer</span><span class=b> : Maybe Answer</span><span class=c> -></span><span class=b> Html Never</span></span>
<span class=a><span class=g>viewAnswer</span><span class=d> possibleAnswer </span><span class=b>=</span></span>
<span class=a><span class=b>    case </span><span class=d>possibleAnswer </span><span class=b>of</span></span>
<span class=a><span class=d>        Just (Answer content </span><span class=b>_</span><span class=d>) </span><span class=c>-></span></span>
<span class=a><span class=d>            Html</span><span class=b>.</span><span class=d>text content</span></span>

<span class=a><span class=d>        Nothing </span><span class=c>-></span></span>
<span class=a><span class=d>            Html</span><span class=b>.</span><span class=d>text </span><span class=h>"No answer yet"</span></span>
</code></pre><p>And our Union type approach:<pre><code><span class=a><span class=b>import</span><span class=d> Html </span><span class=b>exposing</span><span class=d> (</span><span class=b>Html</span><span class=d>)</span></span>

<span class=a><span class=b>type Answer</span></span>
<span class=a><span class=c>    =</span><span class=d> Answered </span><span class=b>String Date</span></span>
<span class=a><span class=c>    |</span><span class=d> NoAnswerYet</span></span>


<span class=a><span class=b>type alias Question</span><span class=c> =</span></span>
<span class=a><span class=d>    { id: </span><span class=b>String</span></span>
<span class=a><span class=e>    ,</span><span class=f> date</span><span class=b> : Date</span></span>
<span class=a><span class=e>    ,</span><span class=d> content: </span><span class=b>String</span></span>
<span class=a><span class=e>    ,</span><span class=d> answer: </span><span class=b>Answer</span></span>
<span class=a><span class=d>    }</span></span>

<span class=a><span class=g>viewAnswer</span><span class=b> : Answer</span><span class=c> -></span><span class=b> Html Never</span></span>
<span class=a><span class=g>viewAnswer</span><span class=d> answer </span><span class=b>=</span></span>
<span class=a><span class=b>    case </span><span class=d>answer </span><span class=b>of</span></span>
<span class=a><span class=d>        Answered content </span><span class=b>_</span><span class=c> -></span></span>
<span class=a><span class=d>            Html</span><span class=b>.</span><span class=d>text content</span></span>

<span class=a><span class=d>        NoAnswerYet </span><span class=c>-></span></span>
<span class=a><span class=d>            Html</span><span class=b>.</span><span class=d>text </span><span class=h>"No answer yet"</span></span>
</code></pre><p>As you can see our Union type approach is less code (you don't have to write <code>Maybe</code> and <code>Just</code> for the value) and has more clarity. Using Maybe does fix it quickly. But, it adds an extra level of abstraction around our Answer type. Having to unwrap the Maybe first to get to our Answer type. With the Custom Type approach, it is clear that we have an answer or no answer, this shows more intent than a Maybe. Also, our code emits an uncertainty when using Maybe. A great talk about uncertainties in your Elm code can be watched here: <a rel="noopener nofollow noreferrer external" target=_blank href=https://youtu.be/43eM4kNbb6c>Working with Maybe</a> by Joël Quenneville. We don't want any uncertainties in our code. We are certain that when decoded we either have an answer or have no answer.<p>On the downside, when going for the Custom Type approach, we do lose the possibility for using <code>Maybe.map</code> and have to use case for everything. This boils down to having the power of mapping or clarity of intent in our code. Since we, developers, read code more than we write (said by Robert C. Martin in his book Clean Code and by many others) it means that clarity of intent trumps power we decided to go with the Custom Type approach.<h2 id=making-the-seemly-impossible-impossible>Making the seemly impossible impossible</h2><p>First, we change our Answer type that represents our only two possible cases.<pre><code><span class=a><span class=b>type Answer</span></span>
<span class=a><span class=c>    =</span><span class=d> Answered </span><span class=b>String Date</span></span>
<span class=a><span class=c>    |</span><span class=d> NoAnswerYet</span></span>
</code></pre><p>Then we change our decoder to set return the Answered type if all is well and <code>NoAnswerYet</code> for the other cases where one or more of the fields are <code>null</code>. To make our code more concise we use <a rel="noopener nofollow noreferrer external" target=_blank href=http://package.elm-lang.org/packages/elm-community/json-extra/2.7.0/Json-Decode-Extra#withDefault><code>Json.Decode.Extra.withDefault</code></a> to set a fallback if one of our fields are <code>null</code>.<pre><code><span class=a><span class=b>import</span><span class=d> Json</span><span class=b>.</span><span class=d>Decode</span><span class=b>.</span><span class=d>Extra </span><span class=b>as</span><span class=d> JDE</span></span>

<span class=a><span class=g>decoder</span><span class=b> :</span><span class=d> JD</span><span class=b>.Decoder Question</span></span>
<span class=a><span class=g>decoder</span><span class=b> =</span></span>
<span class=a><span class=d>    JD</span><span class=b>.</span><span class=d>map4 Question</span></span>
<span class=a><span class=d>        (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"id"</span><span class=d> JD</span><span class=b>.</span><span class=d>string)</span></span>
<span class=a><span class=d>        (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"date"</span><span class=d> DateTime</span><span class=b>.</span><span class=d>decoder)</span></span>
<span class=a><span class=d>        (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"content"</span><span class=d> JD</span><span class=b>.</span><span class=d>string)</span></span>
<span class=a><span class=d>        (JD</span><span class=b>.</span><span class=d>map2 Answered</span></span>
<span class=a><span class=d>            (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"answer"</span><span class=d> JD</span><span class=b>.</span><span class=d>string)</span></span>
<span class=a><span class=d>            (JD</span><span class=b>.</span><span class=d>field </span><span class=h>"answeredOn"</span><span class=d> DateTime</span><span class=b>.</span><span class=d>decoder)</span></span>
<span class=a><span class=c>            |></span><span class=d> JDE</span><span class=b>.</span><span class=d>withDefault NoAnswerYet</span></span>
<span class=a><span class=d>        )</span></span>
</code></pre><p>Now our code is safe from weird cases and is more expressive! Having fewer possible cases means fewer possible bugs, makes it easier to test, and easier to reason about what the code can do. Another small advantage is that you won't have to write tests for the other weird cases. If you try to write such a test the compiler just won't allow you. Thus, we don't need to write any tests and save time. With this, we fixed our bug using the powerful Elm type system.<p>You can check out the final here: <a rel="noopener nofollow noreferrer external" target=_blank href=https://ellie-app.com/PnhF7yzQtra1>https://ellie-app.com/PnhF7yzQtra1</a><p>If you are interested in learning more about fixing similar problems in your Elm application I highly recommend to watch <a rel="noopener nofollow noreferrer external" target=_blank href=https://youtu.be/IcgmSRJHu_8>Making Impossible States Impossible</a> by Richard Feldman.</section><footer>Published on <time datetime=2018-08-13T00:00:00 itemprop=datePublished>2018-08-13</time><br>Tags: <a href=/tags/#custom-types title="See all posts for Custom Types">Custom Types</a>, <a href=/tags/#elm title="See all posts for Elm">Elm</a>, <a href=/tags/#maybe title="See all posts for Maybe">Maybe</a>, <a href=/tags/#monads title="See all posts for Monads">Monads</a><br>Source <a href=https:&#x2F;&#x2F;github.com&#x2F;brianvanburken&#x2F;brianvanburken.github.io&#x2F;tree&#x2F;master&#x2F;content/maybe-dont-use-maybe.md target=_blank rel="noopener noreferrer" title="View post source on Github">on Github</a></footer></article><script data-goatcounter=https://brianvanburken.goatcounter.com/count async src=https://gc.zgo.at/count.js></script><noscript><img src="https://brianvanburken.goatcounter.com/count?p=/maybe-dont-use-maybe/"></noscript>