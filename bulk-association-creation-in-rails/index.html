<!DOCTYPE html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="data:,"><style>html{background:#0b0e14;color:#fff}body{font-family:Avenir Next,Open Sans,Helvetica,sans-serif;font-size:1.125rem;margin:1.5rem auto;max-width:70ch;padding:0 1.5rem}article,code,footer,h1,p,pre{line-height:1.5rem;margin:1.5rem 0}h1{font-size:2.5rem;line-height:3rem}p{text-align:justify}img{max-width:100%}a{color:#fa3}a:visited{color:#ff9500}a:focus,a:hover{color:#ffbf66}footer{border-top:1px solid #bfbdb6;padding-top:1.5rem}code,pre{font-size:.875rem;word-break:normal;word-spacing:normal;word-wrap:normal;background:#0b0e14;border-radius:.375rem;color:#bfbdb6;hyphens:none}pre{overflow:auto;padding:1.5rem}p code{line-height:1;margin:0 2px;outline:3px solid #0b0e14}@media (prefers-color-scheme:light){html{background:#fff;color:#0b0e14}}.j{color:#95e6cb}.d{color:#59c2ff}.i{color:#f29668}.f{color:#39bae6}.e{color:#bfbdb6b3}.h{color:#ffb454}.c{color:#ff8f40}.g{color:#d2a6ff}.l{color:#aad94c}</style><link type="application/atom+xml" rel="alternate" href="https://brianvanburken.nl/feed.xml" title="Brian van Burken"><title>Bulk Association Creation in Rails | Brian van Burken</title><meta name="generator" content="Jekyll v4.4.1"><meta property="og:title" content="Bulk Association Creation in Rails"><meta property="og:locale" content="en_US"><meta name="description" content="During development of an application I stumbled across a situation that could be improved. The application contains posts that get tagged based on the content. Beneath you can see all the models in this situation."><meta property="og:description" content="During development of an application I stumbled across a situation that could be improved. The application contains posts that get tagged based on the content. Beneath you can see all the models in this situation."><link rel="canonical" href="https://brianvanburken.nl/bulk-association-creation-in-rails/"><meta property="og:url" content="https://brianvanburken.nl/bulk-association-creation-in-rails/"><meta property="og:site_name" content="Brian van Burken"><meta property="og:type" content="article"><meta property="article:published_time" content="2015-08-22T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta property="twitter:title" content="Bulk Association Creation in Rails"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-10-30T15:07:32+00:00","datePublished":"2015-08-22T00:00:00+00:00","description":"During development of an application I stumbled across a situation that could be improved. The application contains posts that get tagged based on the content. Beneath you can see all the models in this situation.","headline":"Bulk Association Creation in Rails","mainEntityOfPage":{"@type":"WebPage","@id":"https://brianvanburken.nl/bulk-association-creation-in-rails/"},"url":"https://brianvanburken.nl/bulk-association-creation-in-rails/"}</script><p><a href="/" title="Overview of all my writings">Writings</a> | <a href="https://github.com/brianvanburken" title="Visit my GitHub profile" target="_blank" rel="noopener noreferrer">GitHub</a> | <a href="https://linkedin.com/in/brianvanburken" title="Visit my LinkedIn profile" target="_blank" rel="noopener noreferrer">LinkedIn</a><article itemscope itemtype="http://schema.org/BlogPosting"><h1 itemprop="name headline">Bulk Association Creation in Rails</h1><section itemprop="articleBody"><p>During development of an application I stumbled across a situation that could be improved. The application contains posts that get tagged based on the content. Beneath you can see all the models in this situation.<pre tabindex="0"><code><span class="c">class</span><span class="d"> Post</span><span class="e"> &lt;</span><span class="f"> ActiveRecord</span><span class="e">::</span><span class="f">Base</span>
  has_many <span class="g">:taggings</span><span class="e">,</span><span class="g"> as: :taggable</span>
  has_many <span class="g">:tags</span><span class="e">,</span><span class="g"> through: :taggings</span>
  after_save <span class="g">:tag_content</span><span class="e">,</span><span class="g"> if: :content_changed?</span>

<span class="c">  private

  def</span><span class="h"> tag_content</span>
    words <span class="i">=</span> content<span class="e">.</span><span class="h">strip</span><span class="e">.</span><span class="h">downcase</span><span class="e">.</span><span class="h">split</span>(/<span class="j">\W+</span>/)
<span class="f">    TaggingService</span><span class="e">.</span><span class="c">new</span>(<span class="f">self</span>)<span class="e">.</span><span class="h">tag</span>(words)
<span class="c">  end
end

class</span><span class="d"> Tagging</span><span class="e"> &lt;</span><span class="f"> ActiveRecord</span><span class="e">::</span><span class="f">Base</span>
  belongs_to <span class="g">:taggable</span><span class="e">,</span><span class="g"> polymorphic: true</span>
  belongs_to <span class="g">:tag</span>
<span class="c">end

class</span><span class="d"> Tag</span><span class="e"> &lt;</span><span class="f"> ActiveRecord</span><span class="e">::</span><span class="f">Base</span>
  has_many <span class="g">:taggings</span>
<span class="c">end</span>
</code></pre><p>When changing the content of a post it passes the words to a service which tags the post. It deletes all the current taggings to make sure irrelevant tags are no longer present. Then it walks through all the stored tags. Below is the tagging service which handles the automatic tagging.<pre tabindex="0"><code><span class="c">class</span><span class="d"> TaggingService</span>
<span class="c">  def</span><span class="h"> initialize</span>(<span class="g">record</span>)
<span class="h">    @record</span><span class="i"> =</span> record
<span class="c">  end

  def</span><span class="h"> tag</span>(<span class="g">words</span>)
<span class="h">    @record</span><span class="e">.</span><span class="h">taggings</span><span class="e">.</span><span class="h">destroy_all</span>
<span class="f">    Tag</span><span class="e">.</span><span class="h">all</span><span class="e">.</span><span class="h">each</span><span class="c"> do</span><span class="e"> |</span>tag<span class="e">|</span>
      record<span class="e">.</span><span class="h">tags</span><span class="i"> &lt;&lt;</span> tag <span class="c">if</span> words<span class="e">.</span><span class="h">include?</span> tag<span class="e">.</span><span class="h">name</span>
<span class="c">    end
  end
end</span>
</code></pre><p>The problem with this service is that it walks through all the tags, even the ones that aren’t present in the content. We could improve this by only fetching relevant tags. By changing the query we can skip the check for included tag names.<pre tabindex="0"><code><span class="c">def</span><span class="h"> tag</span>(<span class="g">words</span>)
<span class="h">  @record</span><span class="e">.</span><span class="h">taggings</span><span class="e">.</span><span class="h">destroy_all</span>
<span class="f">  Tag</span><span class="e">.</span><span class="h">where</span>(<span class="g">name:</span> words)<span class="e">.</span><span class="h">each</span><span class="c"> do</span><span class="e"> |</span>tag<span class="e">|</span>
    record<span class="e">.</span><span class="h">tags</span><span class="i"> &lt;&lt;</span> tag
<span class="c">  end
end</span>
</code></pre><p>It’s an improvement, but still walks through each tag and as a result produces N+1 queries. After looking through the source of Rails I’ve found that it’s possible to pass a <code>ActiveRecord::Relation</code> instance at the <code>CollectionProxy</code> of the post instance. A CollectionProxy is an object that handles associating records, in this case the post with its taggings and tags.<p>Rails would use the <code>ActiveRecord::Relation</code> instance to generate a query and skip fetching data from the database. This would reduce the time spent in Ruby code. To improve our example we pass in the query we improved earlier.<pre tabindex="0"><code><span class="c">def</span><span class="h"> tag</span>(<span class="g">words</span>)
<span class="h">  @record</span><span class="e">.</span><span class="h">taggings</span><span class="e">.</span><span class="h">destroy_all
  @record</span><span class="e">.</span><span class="h">tags</span><span class="i"> &lt;&lt;</span><span class="f"> Tag</span><span class="e">.</span><span class="h">where</span>(<span class="g">name:</span> words)
<span class="c">end</span>
</code></pre><p>This generates a nice SQL <code>INSERT</code> query that would look like the query below.<pre tabindex="0"><code><span class="c">INSERT INTO</span><span class="l"> "taggings"</span> (<span class="l">"taggable_type"</span>, <span class="l">"taggable_id"</span>, <span class="l">"tag_id"</span>, <span class="l">"created_at"</span>, <span class="l">"updated_at"</span>)
<span class="c">VALUES</span> (<span class="l">"Post"</span>, <span class="g">1</span>, <span class="g">1</span>, <span class="l">"2015-08-22 00:00:00.000000"</span>, <span class="l">"2015-08-22 00:00:00.000000"</span>)
</code></pre></section><footer>Published on <time datetime="2015-08-22T00:00:00+00:00" itemprop="datePublished">2015-08-22 </time><br>Tags: <a href="/tags/#activerecord" title="See all post for ActiveRecord">ActiveRecord</a>, <a href="/tags/#rails" title="See all post for Rails">Rails</a>, <a href="/tags/#ruby" title="See all post for Ruby">Ruby</a><br>Source <a href="https://github.com/brianvanburken/brianvanburken.github.io/tree/master/_posts/2015-08-22-bulk-association-creation-in-rails.md" target="_blank" rel="noopener noreferrer">on Github</a></footer></article><script data-goatcounter="https://brianvanburken.goatcounter.com/count" async src="https://gc.zgo.at/count.js"></script><noscript><img src="https://brianvanburken.goatcounter.com/count?p=/bulk-association-creation-in-rails/"></noscript>