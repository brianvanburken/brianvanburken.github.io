<!DOCTYPE html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/atom+xml title="RSS Feed" href=https://brianvanburken.nl/feed.xml><title>Bulk Association Creation in Rails | Brian van Burken</title><meta property=og:title content="Bulk Association Creation in Rails"><meta name=description content="During development of an application I stumbled across a situation where it produced N+1 queries and I set out on an adventure improve it."><meta property=og:description content="During development of an application I stumbled across a situation where it produced N+1 queries and I set out on an adventure improve it."><meta property=og:type content=article><meta property=og:url content=https:&#x2F;&#x2F;brianvanburken.nl&#x2F;bulk-association-creation-in-rails&#x2F;><meta property=og:site_name content="Brian van Burken"><link rel=canonical href=https:&#x2F;&#x2F;brianvanburken.nl&#x2F;bulk-association-creation-in-rails&#x2F;><meta property=article:published_time content=2015-08-22T00:00:00+00:00><style>html{color:#fff;background:#0b0e14}@media (prefers-color-scheme:light){html{color:#0b0e14;background:#fff}}body{font-family:"Avenir Next","Open Sans",Helvetica,sans-serif;font-size:1.125rem;max-width:70ch;margin:1.5rem auto;padding:0 1.5rem}article,code,footer,h1,p,pre{margin:1.5rem 0;line-height:1.5rem}h1{font-size:2.5rem;line-height:3rem}p{text-align:justify}img{max-width:100%}a,a code{color:#fa3}a:visited{color:#ff9500}a:focus,a:hover{color:#ffbf66}footer{border-top:1px solid #bfbdb6;padding-top:1.5rem}code,pre{font-size:.875rem;word-spacing:normal;word-break:normal;word-wrap:normal;hyphens:none;color:#bfbdb6;background:#0b0e14;border-radius:.375rem}pre{overflow:auto;padding:1.5rem}p code{line-height:1;outline:3px solid #0b0e14;margin:0 2px}.b{color:#ff8f40}.c{color:#59c2ff}.f{color:#bfbdb6}.i{color:#f29668}.e{color:#39bae6}.d{color:#bfbdb6b3}.k{color:#aad94c}.h{color:#ffb454}.g{color:#d2a6ff}.j{color:#95e6cb}</style><p><a href=/ title="Overview of all my writings">Writings</a> | <a href=https://github.com/brianvanburken title="Visit my GitHub profile" target=_blank rel="noopener noreferrer">GitHub</a> | <a href=https://linkedin.com/in/brianvanburken title="Visit my LinkedIn profile" target=_blank rel="noopener noreferrer">LinkedIn</a><article itemscope itemtype=http://schema.org/BlogPosting><h1 itemprop="name headline">Bulk Association Creation in Rails</h1><section itemprop=articleBody><p>During development of an application I stumbled across a situation that could be improved. The application contains posts that get tagged based on the content. Beneath you can see all the models in this situation.<pre><code><span class=a><span class=b>class</span><span class=c> Post</span><span class=d> &#x3C;</span><span class=e> ActiveRecord</span><span class=d>::</span><span class=e>Base</span></span>
<span class=a><span class=f>  has_many </span><span class=g>:taggings</span><span class=d>,</span><span class=g> as: :taggable</span></span>
<span class=a><span class=f>  has_many </span><span class=g>:tags</span><span class=d>,</span><span class=g> through: :taggings</span></span>
<span class=a><span class=f>  after_save </span><span class=g>:tag_content</span><span class=d>,</span><span class=g> if: :content_changed?</span></span>

<span class=a><span class=b>  private</span></span>

<span class=a><span class=b>  def</span><span class=h> tag_content</span></span>
<span class=a><span class=f>    words </span><span class=i>=</span><span class=f> content</span><span class=d>.</span><span class=h>strip</span><span class=d>.</span><span class=h>downcase</span><span class=d>.</span><span class=h>split</span><span class=f>(/</span><span class=j>\W+</span><span class=f>/)</span></span>
<span class=a><span class=e>    TaggingService</span><span class=d>.</span><span class=b>new</span><span class=f>(</span><span class=e>self</span><span class=f>)</span><span class=d>.</span><span class=h>tag</span><span class=f>(words)</span></span>
<span class=a><span class=b>  end</span></span>
<span class=a><span class=b>end</span></span>

<span class=a><span class=b>class</span><span class=c> Tagging</span><span class=d> &#x3C;</span><span class=e> ActiveRecord</span><span class=d>::</span><span class=e>Base</span></span>
<span class=a><span class=f>  belongs_to </span><span class=g>:taggable</span><span class=d>,</span><span class=g> polymorphic: true</span></span>
<span class=a><span class=f>  belongs_to </span><span class=g>:tag</span></span>
<span class=a><span class=b>end</span></span>

<span class=a><span class=b>class</span><span class=c> Tag</span><span class=d> &#x3C;</span><span class=e> ActiveRecord</span><span class=d>::</span><span class=e>Base</span></span>
<span class=a><span class=f>  has_many </span><span class=g>:taggings</span></span>
<span class=a><span class=b>end</span></span>
</code></pre><p>When changing the content of a post it passes the words to a service which tags the post. It deletes all the current taggings to make sure irrelevant tags are no longer present. Then it walks through all the stored tags. Below is the tagging service which handles the automatic tagging.<pre><code><span class=a><span class=b>class</span><span class=c> TaggingService</span></span>
<span class=a><span class=b>  def</span><span class=h> initialize</span><span class=f>(</span><span class=g>record</span><span class=f>)</span></span>
<span class=a><span class=h>    @record</span><span class=i> =</span><span class=f> record</span></span>
<span class=a><span class=b>  end</span></span>

<span class=a><span class=b>  def</span><span class=h> tag</span><span class=f>(</span><span class=g>words</span><span class=f>)</span></span>
<span class=a><span class=h>    @record</span><span class=d>.</span><span class=h>taggings</span><span class=d>.</span><span class=h>destroy_all</span></span>
<span class=a><span class=e>    Tag</span><span class=d>.</span><span class=h>all</span><span class=d>.</span><span class=h>each</span><span class=b> do</span><span class=d> |</span><span class=f>tag</span><span class=d>|</span></span>
<span class=a><span class=f>      record</span><span class=d>.</span><span class=h>tags</span><span class=i> &#x3C;&#x3C;</span><span class=f> tag </span><span class=b>if</span><span class=f> words</span><span class=d>.</span><span class=h>include?</span><span class=f> tag</span><span class=d>.</span><span class=h>name</span></span>
<span class=a><span class=b>    end</span></span>
<span class=a><span class=b>  end</span></span>
<span class=a><span class=b>end</span></span>
</code></pre><p>The problem with this service is that it walks through all the tags, even the ones that aren’t present in the content. We could improve this by only fetching relevant tags. By changing the query we can skip the check for included tag names.<pre><code><span class=a><span class=b>def</span><span class=h> tag</span><span class=f>(</span><span class=g>words</span><span class=f>)</span></span>
<span class=a><span class=h>  @record</span><span class=d>.</span><span class=h>taggings</span><span class=d>.</span><span class=h>destroy_all</span></span>
<span class=a><span class=e>  Tag</span><span class=d>.</span><span class=h>where</span><span class=f>(</span><span class=g>name:</span><span class=f> words)</span><span class=d>.</span><span class=h>each</span><span class=b> do</span><span class=d> |</span><span class=f>tag</span><span class=d>|</span></span>
<span class=a><span class=f>    record</span><span class=d>.</span><span class=h>tags</span><span class=i> &#x3C;&#x3C;</span><span class=f> tag</span></span>
<span class=a><span class=b>  end</span></span>
<span class=a><span class=b>end</span></span>
</code></pre><p>It’s an improvement, but still walks through each tag and as a result produces N+1 queries. After looking through the source of Rails I’ve found that it’s possible to pass a <code>ActiveRecord::Relation</code> instance at the <code>CollectionProxy</code> of the post instance. A CollectionProxy is an object that handles associating records, in this case the post with its taggings and tags.<p>Rails would use the <code>ActiveRecord::Relation</code> instance to generate a query and skip fetching data from the database. This would reduce the time spent in Ruby code. To improve our example we pass in the query we improved earlier.<pre><code><span class=a><span class=b>def</span><span class=h> tag</span><span class=f>(</span><span class=g>words</span><span class=f>)</span></span>
<span class=a><span class=h>  @record</span><span class=d>.</span><span class=h>taggings</span><span class=d>.</span><span class=h>destroy_all</span></span>
<span class=a><span class=h>  @record</span><span class=d>.</span><span class=h>tags</span><span class=i> &#x3C;&#x3C;</span><span class=e> Tag</span><span class=d>.</span><span class=h>where</span><span class=f>(</span><span class=g>name:</span><span class=f> words)</span></span>
<span class=a><span class=b>end</span></span>
</code></pre><p>This generates a nice SQL <code>INSERT</code> query that would look like the query below.<pre><code><span class=a><span class=b>INSERT INTO</span><span class=k> "taggings"</span><span class=f> (</span><span class=k>"taggable_type"</span><span class=f>, </span><span class=k>"taggable_id"</span><span class=f>, </span><span class=k>"tag_id"</span><span class=f>, </span><span class=k>"created_at"</span><span class=f>, </span><span class=k>"updated_at"</span><span class=f>)</span></span>
<span class=a><span class=b>VALUES</span><span class=f> (</span><span class=k>"Post"</span><span class=f>, </span><span class=g>1</span><span class=f>, </span><span class=g>1</span><span class=f>, </span><span class=k>"2015-08-22 00:00:00.000000"</span><span class=f>, </span><span class=k>"2015-08-22 00:00:00.000000"</span><span class=f>)</span></span>
</code></pre></section><footer>Published on <time datetime=2015-08-22T00:00:00 itemprop=datePublished>2015-08-22</time><br>Tags: <a href=/tags/#activerecord title="See all posts for ActiveRecord">ActiveRecord</a>, <a href=/tags/#rails title="See all posts for Rails">Rails</a>, <a href=/tags/#ruby title="See all posts for Ruby">Ruby</a><br>Source <a href=https:&#x2F;&#x2F;github.com&#x2F;brianvanburken&#x2F;brianvanburken.github.io&#x2F;tree&#x2F;master&#x2F;content/bulk-association-creation-in-rails.md target=_blank rel="noopener noreferrer" title="View post source on Github">on Github</a></footer></article><script data-goatcounter=https://brianvanburken.goatcounter.com/count async src=https://gc.zgo.at/count.js></script><noscript><img src="https://brianvanburken.goatcounter.com/count?p=/bulk-association-creation-in-rails/"></noscript>